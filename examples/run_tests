#!/bin/bash
files=`find -name referencexmu.dat`
pd=`pwd`
if [ "X$1" == "X" ]
then
	cmd="$pd/../bin/feff"
else
	cmd='echo'
fi
rm -f test.log
for file in $files
do
	dir=`dirname $file`
	cd $dir
	echo
	echo '##################################################################################################'
	echo '##################################################################################################'
	echo "Test: $file"
	echo '##################################################################################################'
	echo '##################################################################################################'
	$cmd |tee feff.out |sed 's/^/       /'
        # Get reference files.
        rfiles=`ls reference*`
	for rfile in $rfiles
	do
		fl=`echo $rfile |sed -e's/reference//g'`
		if [ "X$fl" == "Xxmu.dat" ]
		then
			grep -v '#' xmu.dat |nl > xmu1.dat 
			grep -v '#' $rfile |nl > xmu2.dat
			echo 
			echo '##################################################################################################'
			echo '##################################################################################################'
			echo -n "$file: "
			paste xmu1.dat xmu2.dat |awk 'BEGIN{s4=0.0;s6=0.0;diff4=0.0;diff6=0.0} \
			{if($1==$8) {s4=s4+($5+$12)^2; diff4=diff4+($5-$12)^2;s6=s6+($7+$14)^2; diff6=diff6+($7-$14)^2}}END{if(diff4/s4*100.0 < 0.1 && diff6/s6*100.0< 0.1) print "pass"; else print "fail", diff6/s6*100.0}'
			echo '##################################################################################################'
			echo '##################################################################################################'
			echo -n "$file: " >> $pd/test.log
			paste xmu1.dat xmu2.dat |awk 'BEGIN{s4=0.0;s6=0.0;diff4=0.0;diff6=0.0} \
				{if($1==$8) {s4=s4+($5+$12)^2; diff4=diff4+($5-$12)^2;s6=s6+($7+$14)^2; diff6=diff6+($7-$14)^2}}END{if(diff4/s4*100.0 < 0.1 && diff6/s6*100.0< 0.1) print "pass"; else print "fail", diff6/s6*100.0}' >> $pd/test.log
			echo
		else
			echo '##################################################################################################'
			echo '##################################################################################################'
			echo -n "$file: "
			echo "Skipping for now ..."
			echo '##################################################################################################'
			echo '##################################################################################################'
			echo
			echo -n "$file: " >> $pd/test.log
			echo "Skipping for now ..." >> $pd/test.log
		fi
	done
	cd $pd
done
